
<!DOCTYPE html>
<head>
<title>Shared buffer test</title>
    <style>
        html, body {
            width:  100%;
            height: 100%;
            margin: 0;
        }
    </style>
</head>
<body>
<div><canvas id="image" width="800" height="600" /></div>
    <script>
        const times = [];
        let fps;

        function refreshLoop()
        {
            window.requestAnimationFrame(() =>
            {
                const now = performance.now();
                while (times.length > 0 && times[0] <= now - 1000)
                {
                    times.shift();
                }
                times.push(now);
                fps = times.length;
                refreshLoop();
            });
        }

        refreshLoop();

        var canvas = document.getElementById('image');
        var ctx = canvas.getContext('2d');

        // ctx.canvas.width  = window.innerWidth;
        // ctx.canvas.height = window.innerHeight;

        var usingSA0 = true;
        var pixels = new Uint8ClampedArray(window.sharedArray0);

        function Swap()
        {
            if (!usingSA0)
            {
                pixels = new Uint8ClampedArray(window.sharedArray0);
                usingSA0 = true;
            }
            else
            {
                pixels = new Uint8ClampedArray(window.sharedArray1);
                usingSA0 = false;
            }
        }

        function Draw()
        {
            // create copy of pixels (need to avoid the crash)
            var copyPixels = new Uint8ClampedArray(pixels);
            // create ImageData from copyPixels
            var imgData = new ImageData(copyPixels, canvas.width, canvas.height);
            // draw imgData
            ctx.putImageData(imgData, 0, 0);

            // Print fps (left-top corner)
            ctx.font = '24px serif';
            ctx.fillText(fps, 0, 24);

            // js Drawing done
            window.JsDraws(false);
        }

        // Swap and Draw function registration
        window.RegSwapBuffers(Swap);
        window.RegDrawFunction(Draw);

</script>
</body>